{% extends 'layout.html' %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-start gap-3">
      <div>
        <h3 class="mb-0 hero-title">Reports</h3>
        <div class="muted-small">Manage incoming reports and update status</div>
      </div>
    </div>
    <div>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin_status') }}">Status</a>
    </div>
  </div>

  {# Summary cards: compute counts from current complaints list #}
  {% set total = complaints|length if complaints is defined else 0 %}
  {% set open_count = complaints|selectattr('status','equalto','open')|list|length if complaints is defined else 0 %}
  {% set inprog_count = complaints|selectattr('status','equalto','in-progress')|list|length if complaints is defined else 0 %}
  {% set closed_count = complaints|selectattr('status','equalto','closed')|list|length if complaints is defined else 0 %}

  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-md-3">
      <div class="card p-2 shadow-sm">
        <div class="d-flex align-items-center">
          <div class="me-3 display-6 text-primary"><i class="bi bi-list-check"></i></div>
          <div>
            <div class="small text-muted">Total</div>
            <div class="h5 mb-0">{{ total }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="card p-2 shadow-sm">
        <div class="d-flex align-items-center">
          <div class="me-3 text-warning"><i class="bi bi-exclamation-triangle-fill fs-3"></i></div>
          <div>
            <div class="small text-muted">Open</div>
            <div class="h5 mb-0">{{ open_count }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="card p-2 shadow-sm">
        <div class="d-flex align-items-center">
          <div class="me-3 text-info"><i class="bi bi-arrow-repeat fs-3"></i></div>
          <div>
            <div class="small text-muted">In Progress</div>
            <div class="h5 mb-0">{{ inprog_count }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="card p-2 shadow-sm">
        <div class="d-flex align-items-center">
          <div class="me-3 text-success"><i class="bi bi-check-circle-fill fs-3"></i></div>
          <div>
            <div class="small text-muted">Closed</div>
            <div class="h5 mb-0">{{ closed_count }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3" id="filterForm">
    <div class="col-md-4">
      <label class="form-label small">Search</label>
      <div class="search-box">
        <i class="bi bi-search search-icon"></i>
        <input type="text" name="search" class="form-control form-control-sm" placeholder="Search by title, description, name, room, or address..." value="{{ search_query or '' }}" aria-label="Search complaints">
      </div>
    </div>
    <div class="col-auto">
      <label class="form-label small">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">Any</option>
        <option value="open" {% if request.args.get('status')=='open' %}selected{% endif %}>Open</option>
        <option value="in-progress" {% if request.args.get('status')=='in-progress' %}selected{% endif %}>In Progress</option>
        <option value="closed" {% if request.args.get('status')=='closed' %}selected{% endif %}>Closed</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label small">From</label>
      <input type="date" name="date_from" class="form-control form-control-sm" value="{{ request.args.get('date_from','') }}">
    </div>
    <div class="col-auto">
      <label class="form-label small">To</label>
      <input type="date" name="date_to" class="form-control form-control-sm" value="{{ request.args.get('date_to','') }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-funnel me-1"></i>Apply</button>
      {% if search_query or request.args.get('status') or request.args.get('date_from') or request.args.get('date_to') %}
        <a href="{{ url_for('admin_list') }}" class="btn btn-sm btn-outline-secondary" title="Clear filters"><i class="bi bi-x-lg"></i></a>
      {% endif %}
    </div>
    <div class="col-auto ms-auto">
      {% set qs = request.query_string.decode('utf-8') if request.query_string else '' %}
      <a class="btn btn-sm btn-success" href="{{ url_for('admin_export') }}{% if qs %}?{{ qs }}{% endif %}" title="Export to CSV"><i class="bi bi-file-earmark-spreadsheet me-1"></i>CSV</a>
      <a class="btn btn-sm btn-info text-white" href="{{ url_for('admin_export_json') }}{% if qs %}?{{ qs }}{% endif %}" title="Export to JSON"><i class="bi bi-file-earmark-code me-1"></i>JSON</a>
    </div>
  </form>

  {% if complaints %}
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Name</th>
                <th>Room</th>
                <th>Address</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Created</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for c in complaints %}
              <tr>
                <td class="text-muted">#{{ c.id }}</td>
                <td style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ c.title }}</td>
                <td>{{ c.name or 'Anonymous' }}</td>
                <td class="muted-small">{{ c.room or '—' }}</td>
                <td class="muted-small">{{ c.address or '—' }}</td>
                <td class="muted-small">{% if c.phone %}<a href="tel:{{ c.phone }}">{{ c.phone }}</a>{% else %}—{% endif %}</td>
                <td style="min-width:150px;">
                  {% if c.status == 'open' %}
                    <span class="badge bg-warning text-dark">Open</span>
                  {% elif c.status == 'in-progress' %}
                    <span class="badge bg-info text-dark">In Progress</span>
                  {% elif c.status == 'closed' %}
                    <span class="badge bg-success">Closed</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ c.status }}</span>
                  {% endif %}
                </td>
                <td class="muted-small">
                  <span class="date-display" data-date="{{ c.created_at }}">{{ c.created_at }}</span>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <a class="btn btn-sm btn-primary" href="{{ url_for('view_complaint', complaint_id=c.id) }}">View</a>
                    <form method="post" action="{{ url_for('delete_complaint', complaint_id=c.id) }}" class="d-inline" onsubmit="return confirm('Delete report #{{ c.id }}?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h4>No complaints found</h4>
          <p>{% if search_query or request.args.get('status') or request.args.get('date_from') or request.args.get('date_to') %}Try adjusting your filters or search terms.{% else %}No complaints have been submitted yet.{% endif %}</p>
          {% if search_query or request.args.get('status') or request.args.get('date_from') or request.args.get('date_to') %}
            <a href="{{ url_for('admin_list') }}" class="btn btn-primary mt-2">Clear Filters</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

{% endblock %}

{% block scripts %}
  <script>
    // Format dates to be more readable
    document.querySelectorAll('.date-display').forEach(function(el) {
      const dateStr = el.getAttribute('data-date');
      if (dateStr) {
        try {
          const date = new Date(dateStr);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          let displayText = '';
          if (diffMins < 1) {
            displayText = 'Just now';
          } else if (diffMins < 60) {
            displayText = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
          } else if (diffHours < 24) {
            displayText = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
          } else if (diffDays < 7) {
            displayText = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
          } else {
            displayText = date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
          
          el.textContent = displayText;
          el.setAttribute('title', date.toLocaleString());
        } catch(e) {
          // Keep original if parsing fails
        }
      }
    });

    // Auto-submit search on Enter key
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('filterForm').submit();
        }
      });
    }
  </script>
{% endblock %}

